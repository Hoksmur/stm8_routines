#include "lcd.h"
#include "avmacro.h"
#include "delay.h"


// SPI variant
#define LCD_RST D, (1<<5), L
#define LCD_CS 	D, (1<<6), L
#define LCD_CMD A, (1<<1), L
#define MISO	A, (1<<2), H
#define SCK 	A, (1<<3), H
#define MOSI	D, (1<<4), H


#ifndef RU_EXTENSION
#define	CHTAB_CAP (96*6)
#else
#define CHTAB_CAP (96*6+19*6)
#endif

const char arr_token[CHTAB_CAP] = { 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* space */
	0x00, 0x00, 0x00, 0x5F, 0x00, 0x00, /* ! */
	0x00, 0x04, 0x03, 0x00, 0x04, 0x03, /* " */
	0x00, 0x14, 0x3e, 0x14, 0x3e, 0x14, /* # */
	0x00, 0x24, 0x2A, 0x6B, 0x2A, 0x12,	/* $ */
	0x00, 0x23, 0x13, 0x08, 0x64, 0x62, /* % */
	0x00, 0x36, 0x49, 0x56, 0x20, 0x50, /* & */
	0x00, 0x00, 0x00, 0x06, 0x03, 0x00, /* ' */
	0x00, 0x00, 0x1c, 0x22, 0x41, 0x00, /* ( */
	0x00, 0x00, 0x41, 0x22, 0x1c, 0x00, /* ) */
	0x00, 0x2a, 0x1c, 0x7f, 0x1c, 0x2a, /* * */
	0x00, 0x08, 0x08, 0x3E, 0x08, 0x08, /* + */
	0x00, 0x40, 0x30, 0x30, 0x00, 0x00, /* , */
	0x00, 0x08, 0x08, 0x08, 0x08, 0x08, /* - */
	0x00, 0x30, 0x30, 0x00, 0x00, 0x00, /* . */
	0x00, 0x40, 0x30, 0x08, 0x06, 0x01, /* / */

	0x00, 0x3E, 0x51, 0x49, 0x45, 0x3E, /* 0 */
	0x00, 0x00, 0x42, 0x7F, 0x40, 0x00, /* 1 */
	0x00, 0x42, 0x61, 0x51, 0x49, 0x46, /* 2 */
	0x00, 0x22, 0x41, 0x41, 0x49, 0x36, /* 3 */ 
	0x00, 0x18, 0x14, 0x12, 0x7f, 0x10, /* 4 */ 
	0x00, 0x27,	0x45, 0x45, 0x45, 0x39, /* 5 */ 
	0x00, 0x3E, 0x49, 0x49, 0x49, 0x32, /* 6 */
	0x00, 0x41, 0x21, 0x11, 0x09, 0x07, /* 7 */
	0x00, 0x36, 0x49, 0x49, 0x49, 0x36, /* 8 */
	0x00, 0x26, 0x49, 0x49, 0x49, 0x3E, /* 9 */
	0x00, 0x00, 0x00, 0x22, 0x00, 0x00, /* : */
	0x00, 0x00, 0x40, 0x22, 0x00, 0x00, /* ; */
	0x00, 0x00, 0x08, 0x14, 0x22, 0x41, /* < */
	0x00, 0x14, 0x14, 0x14, 0x14, 0x14, /* = */
	0x00, 0x00, 0x41, 0x22, 0x14, 0x08, /* > */
	0x00, 0x02, 0x01, 0x51, 0x09, 0x06, /* ? */
	0x00, 0x3E, 0x41, 0x5D, 0x49, 0x26, /* @ */

#ifdef RUKOI_COMACT
	0x00, 0x7C, 0x12, 0x11, 0x12, 0x7C,	//C0	192
	0x00, 0x7F, 0x49, 0x49, 0x49, 0x30,	//C1	193
	0x00, 0x7F, 0x40, 0x40, 0x7F, 0xC0,	//D6	214
	0x00, 0xC0, 0x7E, 0x41, 0x7F, 0xC0,	//C4	196
	0x00, 0x7F, 0x49, 0x49, 0x49, 0x41,	//C5	197
	0x00, 0x0E, 0x11, 0x7F, 0x11, 0x0E,	//D4	212
	0x00, 0x7F, 0x01, 0x01, 0x01, 0x01,	//C3	195
	0x00, 0x63, 0x14, 0x08, 0x14, 0x63,	//D5	213
	0x00, 0x7F, 0x10, 0x08, 0x04, 0x7F,	//C8	200
	0x00, 0x7F, 0x10, 0x09, 0x04, 0x7F,	//C9	201
	0x00, 0x7F, 0x08, 0x14, 0x22, 0x41,	//CA	202
	0x00, 0x7C, 0x02, 0x01, 0x01, 0x7F,	//CB	203
	0x00, 0x7F, 0x02, 0x0C, 0x02, 0x7F,	//CC	204
	0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F,	//CD	205
	0x00, 0x3E, 0x41, 0x41, 0x41, 0x3E,	//CE	206
	0x00, 0x7F, 0x01, 0x01, 0x01, 0x7F,	//CF	207
	0x00, 0x46, 0x29, 0x19, 0x09, 0x7F,	//DF	223
	0x00, 0x7F, 0x09, 0x09, 0x09, 0x06,	//D0	208
	0x00, 0x3E, 0x41, 0x41, 0x41, 0x22,	//D1	209
	0x00, 0x01, 0x01, 0x7F, 0x01, 0x01,	//D2	210
	0x00, 0x07, 0x48, 0x48, 0x48, 0x3F,	//D3	211
	0x00, 0x77, 0x08, 0x7F, 0x08, 0x77,	//C6	198
	0x00, 0x7F, 0x49, 0x49, 0x49, 0x36,	//C2	194
	0x00, 0x7F, 0x48, 0x48, 0x48, 0x30,	//DC	220
	0x00, 0x7F, 0x48, 0x30, 0x00, 0x7F,	//DB	219
	0x00, 0x00, 0x49, 0x49, 0x49, 0x36,	//C7	199

	0x00, 0x00, 0x7F, 0x41, 0x41, 0x00,	// [
	0x00, 0x01, 0x06, 0x08, 0x30, 0x40,	/* \ */
	0x00, 0x00, 0x41, 0x41, 0x7F, 0x00,	// ]
	0x00, 0x04, 0x02, 0x01, 0x02, 0x04,	// ^
	0x00, 0x40, 0x40, 0x40, 0x40, 0x40,	// _
	0x00, 0x00, 0x01, 0x02, 0x04, 0x00,	// `

	0x00, 0x20, 0x54, 0x54, 0x54, 0x78,	//E0	224
	0x00, 0x7C, 0x54, 0x54, 0x54, 0x20,	//E1	225
	0x00, 0x7C, 0x40, 0x40, 0x7C, 0xC0,	//F6	246	
	0x00, 0xC0, 0x78, 0x44, 0x7C, 0xC0,	//E4	228
	0x00, 0x38, 0x54, 0x54, 0x54, 0x18,	//E5	229
	0x00, 0x38, 0x44, 0xFC, 0x44, 0x38,	//F4	244
	0x00, 0x7C, 0x04, 0x04, 0x04, 0x00,	//E3	227
	0x00, 0x44, 0x28, 0x10, 0x28, 0x44,	//F5	245
	0x00, 0x7C, 0x20, 0x10, 0x08, 0x7C,	//E8	232
	0x00, 0x7C, 0x20, 0x12, 0x08, 0x7C,	//E9	233
	0x00, 0x7C, 0x10, 0x10, 0x28, 0x44,	//EA	234
	0x00, 0x70, 0x08, 0x04, 0x04, 0x7C,	//EB	235
	0x00, 0x7C, 0x08, 0x10, 0x08, 0x7C,	//EC	236
	0x00, 0x7C, 0x10, 0x10, 0x10, 0x7C,	//ED	237
	0x00, 0x38, 0x44, 0x44, 0x44, 0x38,	//EE	238
	0x00, 0x7C, 0x04, 0x04, 0x04, 0x7C,	//EF	239
	0x00, 0x48, 0x34, 0x14, 0x14, 0x7C,	//FF	255
	0x00, 0x7C, 0x14, 0x14, 0x14, 0x08,	//F0	240
	0x00, 0x38, 0x44, 0x44, 0x44, 0x28,	//F1	241
	0x00, 0x04, 0x04, 0x7C, 0x04, 0x04,	//F2	242
	0x00, 0x0C, 0x50, 0x50, 0x50, 0x3C,	//F3	243
	0x00, 0x6C, 0x10, 0x7C, 0x10, 0x6C,	//E6	230
	0x00, 0x7C, 0x54, 0x54, 0x54, 0x28,	//E2	226
	0x00, 0x7C, 0x50, 0x50, 0x20, 0x00,	//FC	252
	0x00, 0x7C, 0x50, 0x20, 0x00, 0x7C,	//FB	251
	0x00, 0x00, 0x54, 0x54, 0x54, 0x28,	//E7	231

	0x00, 0x00, 0x08, 0x36, 0x41, 0x00,	// {
	0x00, 0x00, 0x00, 0x77, 0x00, 0x00,	// |
	0x00, 0x00, 0x41, 0x36, 0x08, 0x00,	// }
	0x00, 0x08, 0x04, 0x08, 0x10, 0x08,	// ~
//	0x00, 0x3C, 0x26, 0x23, 0x26, 0x3C,	//7F	127
	0x00, 0x00, 0x06, 0x09, 0x09, 0x06, /* ° */
#else
	0x00, 0x7C, 0x12, 0x11, 0x12, 0x7C,	//41	65
	0x00, 0x7F, 0x49, 0x49, 0x49, 0x36,	//42	66
	0x00, 0x3E, 0x41, 0x41, 0x41, 0x22,	//43	67
	0x00, 0x7F, 0x41, 0x41, 0x41, 0x3E,	//44	68
	0x00, 0x7F, 0x49, 0x49, 0x49, 0x41,	//45	69
	0x00, 0x7F, 0x09, 0x09, 0x01, 0x03,	//46	70
	0x00, 0x3E, 0x41, 0x41, 0x51, 0x73,	//47	71
	0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F,	//48	72
	0x00, 0x00, 0x41, 0x7F, 0x41, 0x00,	//49	73
	0x00, 0x20, 0x40, 0x41, 0x3F, 0x01,	//4A	74
	0x00, 0x7F, 0x08, 0x14, 0x22, 0x41,	//4B	75
	0x00, 0x7F, 0x40, 0x40, 0x40, 0x60,	//4C	76
	0x00, 0x7F, 0x02, 0x1C, 0x02, 0x7F,	//4D	77
	0x00, 0x7F, 0x04, 0x08, 0x10, 0x7F,	//4E	78
	0x00, 0x3E, 0x41, 0x41, 0x41, 0x3E,	//4F	79
	0x00, 0x7F, 0x09, 0x09, 0x09, 0x06,	//50	80
	0x00, 0x3E, 0x41, 0x51, 0x21, 0x5E,	//51	81
	0x00, 0x7F, 0x09, 0x19, 0x29, 0x46,	//52	82
	0x00, 0x26, 0x49, 0x49, 0x49, 0x32,	//53	83
	0x00, 0x03, 0x01, 0x7F, 0x01, 0x03,	//54	84
	0x00, 0x3F, 0x40, 0x40, 0x40, 0x3F,	//55	85
	0x00, 0x1F, 0x20, 0x40, 0x20, 0x1F,	//56	86
	0x00, 0x3F, 0x40, 0x38, 0x40, 0x3F,	//57	87
	0x00, 0x63, 0x14, 0x08, 0x14, 0x63,	//58	88
	0x00, 0x03, 0x04, 0x78, 0x04, 0x03,	//59	89
	0x00, 0x63, 0x51, 0x49, 0x45, 0x63,	//5A	90
	0x00, 0x00, 0x7F, 0x41, 0x41, 0x00,	// [
	0x00, 0x01, 0x06, 0x08, 0x30, 0x40,	// slash
	0x00, 0x00, 0x41, 0x41, 0x7F, 0x00,	// ]
	0x00, 0x04, 0x02, 0x01, 0x02, 0x04,	// ^
	0x00, 0x40, 0x40, 0x40, 0x40, 0x40,	// _
	0x00, 0x00, 0x01, 0x02, 0x04, 0x00,	// `
	0x00, 0x20, 0x54, 0x54, 0x78, 0x40,	//61	97
	0x00, 0x7F, 0x28, 0x44, 0x44, 0x38,	//62	98
	0x00, 0x38, 0x44, 0x44, 0x44, 0x28,	//63	99
	0x00, 0x38, 0x44, 0x44, 0x28, 0x7F,	//64	100
	0x00, 0x38, 0x54, 0x54, 0x54, 0x18,	//65	101
	0x00, 0x00, 0x08, 0x7E, 0x09, 0x02,	//66	102
	0x00, 0x18, 0xA4, 0xA4, 0x9C, 0x78,	//67	103
	0x00, 0x7F, 0x08, 0x04, 0x04, 0x78,	//68	104
	0x00, 0x00, 0x44, 0x7D, 0x40, 0x00,	//69	105
	0x00, 0x20, 0x40, 0x40, 0x3D, 0x00,	//6A	106
	0x00, 0x7F, 0x10, 0x28, 0x44, 0x00,	//6B	107
	0x00, 0x00, 0x41, 0x7F, 0x40, 0x00,	//6C	108
	0x00, 0x7C, 0x04, 0x78, 0x04, 0x78,	//6D	109
	0x00, 0x7C, 0x08, 0x04, 0x04, 0x78,	//6E	110
	0x00, 0x38, 0x44, 0x44, 0x44, 0x38,	//6F	111
	0x00, 0xFC, 0x18, 0x24, 0x24, 0x18,	//70	112
	0x00, 0x18, 0x24, 0x24, 0x18, 0xFC,	//71	113
	0x00, 0x7C, 0x08, 0x04, 0x04, 0x08,	//72	114
	0x00, 0x48, 0x54, 0x54, 0x54, 0x24,	//73	115
	0x00, 0x04, 0x04, 0x3F, 0x44, 0x24,	//74	116
	0x00, 0x3C, 0x40, 0x40, 0x20, 0x7C,	//75	117
	0x00, 0x1C, 0x20, 0x40, 0x20, 0x1C,	//76	118
	0x00, 0x3C, 0x40, 0x30, 0x40, 0x3C,	//77	119
	0x00, 0x44, 0x28, 0x10, 0x28, 0x44,	//78	120
	0x00, 0x4C, 0x90, 0x90, 0x90, 0x7C,	//79	121
	0x00, 0x44, 0x64, 0x54, 0x4C, 0x44,	//7A	122

	0x00, 0x00, 0x08, 0x36, 0x41, 0x00,	// {
	0x00, 0x00, 0x00, 0x77, 0x00, 0x00,	// |
	0x00, 0x00, 0x41, 0x36, 0x08, 0x00,	// }
	0x00, 0x08, 0x04, 0x08, 0x10, 0x08,	// ~
//	0x00, 0x3C, 0x26, 0x23, 0x26, 0x3C,	//7F	127 ''
	0x00, 0x00, 0x06, 0x09, 0x09, 0x06, /* ° */
#endif

#ifdef RU_EXTENSION
	0x00, 0x7F, 0x40, 0x7F, 0x40, 0x7F,	//D8	216 /* Ш */
	0x00, 0x22, 0x41, 0x49, 0x49, 0x3E,	//DD	221 /* Э */
	0x00, 0x7F, 0x40, 0x7F, 0x40, 0xFF,	//D9	217 /* Щ */
	0x00, 0x07, 0x08, 0x08, 0x08, 0x7F,	//D7	215 /* Ч */
	0x00, 0x01, 0x7F, 0x48, 0x48, 0x30,	//DA	218 /* Ъ */
	0x00, 0x7F, 0x08, 0x3E, 0x41, 0x3E,	//DE	222 /* Ю */

	0x00, 0x7C, 0x40, 0x7C, 0x40, 0x7C,	//F8	248 /* ш */
	0x00, 0x28, 0x44, 0x54, 0x54, 0x38,	//FD	253 /* э */
	0x00, 0x7C, 0x40, 0x7C, 0x40, 0xFC,	//F9	249 /* щ */
	0x00, 0x0C, 0x10, 0x10, 0x10, 0x7C,	//F7	247 /* ч */
	0x00, 0x04, 0x7C, 0x50, 0x50, 0x20,	//FA	250 /* ъ */
	0x00, 0x7C, 0x10, 0x38, 0x44, 0x38,	//FE	254 /* ю */

	0x00, 0x7C, 0x10, 0x08, 0x7C, 0x00, 0x7C, 0x10, 0x10, 0x7C, 0x00, 0x24, /* ин: */
	0x00, 0x78, 0x14, 0x14, 0x78, 0x00, 0x7C, 0x10, 0x28, 0x44, 0x00, 0x24, /* ак: */
	0x00, 0x7C, 0x54, 0x54, 0x44, 0x00, 0x7C, 0x10, 0x28, 0x44, 0x00, 0x24, /* ек: */

	0x00, 0x00, 0x7f, 0x3e, 0x1c, 0x08,	/* >> */
#endif

};



void lcd_IO_init(void)
{
	dir_in(MISO);
	pull_up(MISO);
	dir_out(SCK);
	dir_out(MOSI);
	dir_out(LCD_CS);
	dir_out(LCD_CMD);
	dir_out(LCD_RST);
	dir_out(LCD_CS);
	pin_off(LCD_CS);
}

void lcd_reset(void)
{
	_delay_us(1);
	pin_on(LCD_RST);
	_delay_us(30);
	pin_off(LCD_RST);
}


uint8_t sspi_trx_byte(char val)
{
	uint8_t msk;
	uint8_t b_val=0;
	for ( msk=0x80; msk!= 0; msk=msk>>1 ) {
		if ( val&msk ) pin_on(MOSI); else pin_off(MOSI);
		_delay_cycl( 6 );
		if ( is_active(MISO) )  b_val |= msk;
		pin_on(SCK);
		_delay_cycl( 6 );
		pin_off(SCK);
	}
	return b_val;
}


void lcd_cmd( uint8_t val)
{
	pin_on(LCD_CMD);
	pin_on(LCD_CS);
	sspi_trx_byte( val );
	pin_off(LCD_CS);
}

void lcd_preset(void)
{
//           CMD   ARGMSK VALUE
//            |       |     |
	lcd_cmd( 0x20| (0x07& 0x01 )); // to extended set
	lcd_cmd( 0x04| (0x03& 0x02 )); // TC  =      b10
	lcd_cmd( 0x10| (0x07& 0x03 )); // bias=     b011
	lcd_cmd( 0x80| (0x7F& 0x48 )); // Vop = b1001000
	lcd_cmd( 0x20| (0x07& 0x00 )); // to normal set HORIZ
//	lcd_cmd( 0x20| (0x07& 0x02 )); // to normal set VERT
	lcd_cmd( 0x08| (0x05& 0x04 )); // 'control' normal
}


void lcd_init(void)
{
	lcd_IO_init();	
	lcd_reset();
//	lcd_cmd( 0x20| (0x07& 0x00 )); // to normal set
	lcd_preset();
}


void lcd_setXY( uint8_t x, uint8_t y)
{
	pin_on(LCD_CMD);
	pin_on(LCD_CS);
    sspi_trx_byte( 0x80| (0x7F& x )); // set X
    sspi_trx_byte( 0x40| (0x07& y )); // set Y
	pin_off(LCD_CS);
}


void lcd_push_byte( uint8_t bv)
{
	pin_off(LCD_CMD);
	pin_on(LCD_CS);
	sspi_trx_byte( bv );
	pin_off(LCD_CS);
}

// print 'double size' char 
void lcd_pchar_2x2(uint8_t x, uint8_t y, uint8_t tkn)
{
uint8_t i;	
uint8_t bv;	
uint8_t *p;
	lcd_setXY( x*6, y );
	p= &arr_token[(tkn-32)*6];
	for (i=6; i>0; i--) {
		if ( *p&0x01) bv  = 0x03; else bv = 0x00;
		if ( *p&0x02) bv |= 0x0C;
		if ( *p&0x04) bv |= 0x30;
		if ( *p&0x08) bv |= 0xC0;
		lcd_push_byte(bv);
		lcd_push_byte(bv);
		p++;
	}
	lcd_setXY( x*6, y+1 );
	p= &arr_token[(tkn-32)*6];
	for (i=6; i>0; i--) {
		if ( *p&0x10) bv  = 0x03; else bv = 0x00;
		if ( *p&0x20) bv |= 0x0C;
		if ( *p&0x40) bv |= 0x30;
		if ( *p&0x80) bv |= 0xC0;
		lcd_push_byte(bv);
		lcd_push_byte(bv);
		p++;
	}
}


// print 'standart size' char 
void lcd_pchar(uint8_t x, uint8_t y, uint8_t tkn)
{
char cnt = 6; // width of char
char * p_colum = &arr_token[(tkn-32)*6];
	pin_on(LCD_CMD);
	pin_on(LCD_CS);
	// it shuld start in 'normal' instruction set
	x = x*6;
    sspi_trx_byte( 0x80| (0x7F& x )); // set X
    sspi_trx_byte( 0x40| (0x07& y )); // set Y
    pin_off(LCD_CMD);

    do {
    	sspi_trx_byte( *p_colum );
    	p_colum++;
    } while( --cnt != 0) ;
	pin_off(LCD_CS);
}


// print tokens string 
void lcd_print(uint8_t x, uint8_t y, uint8_t *p_tkn)
{
char cnt;
char * p_colum;
	pin_on(LCD_CMD);
	pin_on(LCD_CS);
	// it should start in 'normal' instruction set
	x = x*6;
    sspi_trx_byte( 0x80| (0x7F& x )); // set X
    sspi_trx_byte( 0x40| (0x07& y )); // set Y
    pin_off(LCD_CMD);

    while ( *p_tkn != '\0') {
    	cnt = 6;
		p_colum = &arr_token[ (*p_tkn-32) * 6];
	    do {
    		sspi_trx_byte( *p_colum );
	    	p_colum++;
	    } while( --cnt != 0) ;
	 	p_tkn++;
    }
	pin_off(LCD_CS);
}

// print tokens string BIG sized
void lcd_print_2x2(uint8_t x, uint8_t y, uint8_t *p_tkn)
{	
uint8_t ix = x;
uint8_t iy = y;
	while ( *p_tkn != '\0' ) {
		lcd_pchar_2x2( ix, iy, *p_tkn);
		p_tkn++;	
		ix += 2;
	}
}
